kind: pipeline
name: default

steps:
  - name: tag
    image: node:11
    environment:
        GITHUB_API_KEY:
          from_secret: rubykube_bot_creds
    commands:
      - git config --global user.name "kite-bot"
      - git config --global user.email "support@rubykube.io"
      - git remote add authenticated-origin https://kite-bot:$GITHUB_API_KEY@github.com/${DRONE_REPO}
      - git fetch
      - yarn config set version-git-message "[ci Skip] Bump %s"
      - yarn config set version-tag-prefix "streamex-"
      - yarn version --patch -y
      - git push authenticated-origin master
      - git push --tags authenticated-origin master
      - git describe --tags $(git rev-list --tags --max-count=1) > .tags
    when:
      event:
        - push

  - name: "Build container"
    image: plugins/gcr
    settings:
      repo: gcr.io/helios-stage/mockserver
      json_key:
        from_secret: openware_gcp_creds_base64
    when:
      event:
        - push

  # - name: deploy
  #   image: rubykube/mock-cloud:v0.0.1
  #   environment:
  #     WEBHOOK_JWT_SECRET:
  #       from_secret: mockserver_webhook_secret
  #     WEBHOOK_URI: "http://mock.openware.work:1338"
  #   commands:
  #     - export latest_image=gcr.io/helios-stage/mockserver:$(cat .tags)
  #     - cd /home/app
  #     - bundle exec rake payload:send[mockserver-streamex,$latest_image,$WEBHOOK_URI]
  #   when:
  #     event:
  #       - push
